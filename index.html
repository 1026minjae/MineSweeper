<!DOCTYPE html5>

<html>

<head>
<meta charset="utf-8" />
<title>Minesweeper</title>

<style>
td {
    width: 30px;
    height: 30px;
    margin: 1px 1px 1px 1px;
    padding: 0 0 0 0;
    border: black 1px solid;
    font-weight: bold;
    font-size: 16px;
    text-align: center;
}

td.unchecked {
    background-color: grey;
}

td.checked {
    background-color: lightgrey;
}

td.mine {
    background-color: red;
}
</style>

<script>
const GAMEBOARDSIZE_MIN = 9;
const GAMEBOARDSIZE_MAX = 25;
const MARK_WALL = 10;
const MARK_MINE = 11;

window.onload = () => {
    initGameBoardData ();
    initGameBoardUI ();
};

function initGameBoardData () {
    gameBoardData = new Array(GAMEBOARDSIZE_MAX + 2);

    gameBoardData[0] = Array.from ({length: GAMEBOARDSIZE_MAX + 2}, () => MARK_WALL);

    for (let i = 1; i <= GAMEBOARDSIZE_MAX; ++i) {
        gameBoardData[i] = Array.from ({length: GAMEBOARDSIZE_MAX + 2}, () => 0);
        gameBoardData[i][0] = MARK_WALL;
        gameBoardData[i][GAMEBOARDSIZE_MAX + 1] = MARK_WALL;
    }

    gameBoardData[GAMEBOARDSIZE_MAX + 1] = Array.from ({length: GAMEBOARDSIZE_MAX + 2}, () => MARK_WALL);
}

function initGameBoardUI () {
    let gameBoardWidthSelector = document.querySelector("#gameBoardWidthSelector");
    let gameBoardHeightSelector = document.querySelector("#gameBoardHeightSelector");
    let gameBoardLevelSelector = document.querySelector("#gameBoardLevelSelector");
    gameBoardWidthSelector.addEventListener("change", newGame);
    gameBoardHeightSelector.addEventListener("change", newGame);
    gameBoardLevelSelector.addEventListener("change", newGame);

    window.oncontextmenu = () => {
        return false;
    };
}

function newGame () {
    let gameBoardWidth = document.querySelector("#gameBoardWidthSelector").value;
    let gameBoardHeight = document.querySelector("#gameBoardHeightSelector").value;
    let gameBoardLevel = document.querySelector("#gameBoardLevelSelector").value;

    document.querySelector("#gameBoardWidthDisplay").innerHTML = gameBoardWidth.toString();
    document.querySelector("#gameBoardHeightDisplay").innerHTML = gameBoardHeight.toString();
    document.querySelector("#gameBoardLevelDisplay").innerHTML = gameBoardLevel.toString();

    resetGameBoardData(gameBoardWidth, gameBoardHeight);
    resetGameBoardUI(gameBoardWidth, gameBoardHeight);

    pickMineLocations(gameBoardWidth, gameBoardHeight, gameBoardLevel);
}

function resetGameBoardData (gameBoardWidth, gameBoardHeight) {
    gameBoardData[0] = Array.from ({length: GAMEBOARDSIZE_MAX + 2}, () => MARK_WALL);

    for (let i = 1; i <= gameBoardHeight; ++i) {
        for (let j = 1; j <= gameBoardWidth; ++j) {
            gameBoardData[i][j] = 0;
        }
        gameBoardData[i][gameBoardHeight + 1] = MARK_WALL;
    }

    for (let j = 0; j <= gameBoardWidth + 1; ++j) {
        gameBoardData[gameBoardWidth][j] = MARK_WALL;
    }
}

function resetGameBoardUI (gameBoardWidth, gameBoardHeight) {
    let gameBoardUI = document.querySelector("#gameBoardUI");

    gameBoardUI.innerHTML = "";

    for (let h = 1; h <= gameBoardHeight; ++h) {
        newRow = document.createElement("tr");

        for (let w = 1; w <= gameBoardWidth; ++w) {
            newCell = document.createElement("td");

            newCellID = "c" + w.toString() + "_" + h.toString();
            newCell.setAttribute("id", newCellID);
            newCell.setAttribute("class", "unchecked");
            newCell.dataset.rowIndex = w;
            newCell.dataset.colIndex = h;

            newCell.addEventListener("click", cellLeftClicked);
            newCell.addEventListener("contextmenu", cellRightClicked);

            newRow.appendChild(newCell);
         }

        gameBoardUI.appendChild(newRow);
     }
}

function cellLeftClicked (e) {
    let clickedCell = e.target;
    let rowIndex = clickedCell.dataset.rowIndex;
    let colIndex = clickedCell.dataset.colIndex;

    if (clickedCell.className === "unchecked") {
        clickedCell.removeEventListener("contextmenu", cellRightClicked);

        if (gameBoardData[colIndex][rowIndex] === MARK_MINE) {
            clickedCell.className = "mine";
            clickedCell.innerHTML = "◎";
        }
        else {
            clickedCell.className = "checked";
            clickedCell.innerHTML = gameBoardData[colIndex][rowIndex].toString();
        }
    }
}

function cellRightClicked (e) {
    if (e.target.innerHTML === "") e.target.innerHTML = "?";
    else if (e.target.innerHTML === "?") e.target.innerHTML = "";
}

function pickMineLocations (gameBoardWidth, gameBoardHeight, gameBoardLevel) {
    gameBoardData[1][1] = MARK_MINE;

    for (let i = 1; i <= gameBoardHeight; ++i) {
        for (let j = 1; j <= gameBoardWidth; ++j) {
            if (gameBoardData[i][j] === MARK_MINE) continue;

            let mineCnt = 0;
            if (gameBoardData[i-1][j-1] === MARK_MINE) ++mineCnt;
            if (gameBoardData[i-1][j] === MARK_MINE) ++mineCnt;
            if (gameBoardData[i-1][j+1] === MARK_MINE) ++mineCnt;
            if (gameBoardData[i][j-1] === MARK_MINE) ++mineCnt;
            if (gameBoardData[i][j+1] === MARK_MINE) ++mineCnt;
            if (gameBoardData[i+1][j-1] === MARK_MINE) ++mineCnt;
            if (gameBoardData[i+1][j] === MARK_MINE) ++mineCnt;
            if (gameBoardData[i+1][j+1] === MARK_MINE) ++mineCnt;

            gameBoardData[i][j] = mineCnt;
        }
    }
}

</script>
</head>

<body>
<font class="menuText">게임보드 가로: <span id="gameBoardWidthDisplay">17</span>칸</font>
<input id="gameBoardWidthSelector" type="range" min="9" max="25" step="1" />
<font class="menuText">게임보드 세로: <span id="gameBoardHeightDisplay">17</span>칸</font>
<input id="gameBoardHeightSelector" type="range" min="9" max="25" step="1" />
<font class="menuText">레벨: <span id="gameBoardLevelDisplay">6</span></font>
<input id="gameBoardLevelSelector" type="range" min="1" max="10" step="1" />
<table id="gameBoardUI"></table>
</body>

</html>
